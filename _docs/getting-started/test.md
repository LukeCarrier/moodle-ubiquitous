# Using Ubiquitous in test environments

The testing configuration is designed for use in continuous integration platforms built around containers. In this setup, all services are installed to a single container. At test time, the hosting service will either mount a volume or copy the files into the container, then run a series of shell commands which will start the services and run the tests.

## Pre-built containers

[Pre-built containers](https://hub.docker.com/r/lukecarrier/moodle-ubiquitous/) are made available on Docker Hub. Since these containers may change on a whim, potentially interfering with your test results, you're advised to follow the instructions below to build your own container images.

## Building containers

The recommended approach for building the container image is to allow the Docker Hub to run the build against your Git repository using webhooks, ensuring that your container image is always up to date. See [the Docker Hub automated builds](https://docs.docker.com/docker-hub/builds/), Docker Hub will perform automated builds of the container image from the repository.

The Docker container image can be built from the [Dockerfile](../../Dockerfile) with a single command:

```
$ docker build .
```

## Testing the containers

First, prepare an alternative Moodle directory you can mount as a volume on your container. Reusing an existing directory is not recommended as you will need a different configuration file. Git worktrees may be useful for this:

```
$ cd Moodle/
$ git worktree add ../MoodleDocker
```

Then start the container:

```
$ cd Ubiquitous/
$ docker run -it \
        --volume "$(dirname $PWD)/MoodleDocker":/home/ubuntu/releases/test \
        --workdir /home/ubuntu/releases/test --memory 4g --memory-swap 4g \
        --publish 8080:80 --publish 8044:4444 \
        --publish 8055:5555 --publish 8056:5556 --publish 8057:5557 --publish 8058:5558 \
        --publish 8065:5995 --publish 8066:5996 --publish 8067:5997 --publish 8068:5998 \
        --entrypoint /bin/bash d912563cdbc5
```

Note the `--publish` arguments here, which make the following services accessible once started inside the container:

* [The Moodle site](http://localhost:8080/)
* [Selenium Hub](http://localhost:8044/)
* Selenium Nodes [1](http://localhost:8055/), [2](http://localhost:8056/), [3](http://localhost:8057/) and [4](http://localhost:8058/)
* VNC on Selenium nodes:
    * 1 --- `localhost:8065`
    * 2 --- `localhost:8066`
    * 3 --- `localhost:8067`
    * 4 --- `localhost:8068`

Since systemd is unavailable within the container, services can be started with a control script:

```
$ /usr/local/ubiquitous/bin/ubiquitous-ctl start
```

We then need to copy the Moodle configuration file generated by the Salt states into place and ensure the permissions on our Moodle volume are correct:

```
$ cp ~ubuntu/config.php ~ubuntu/releases/test/config.php
$ chown -R ubuntu:ubuntu ~ubuntu/releases/test
```

We should now be able to install Moodle:

```
$ sudo -iu ubuntu php ~ubuntu/current/admin/cli/install_database.php --agree-license --adminpass='P4$$word'
```

We can now run the PHPUnit suite:

```
$ sudo -iu ubuntu php ~ubuntu/current/admin/tool/phpunit/cli/init.php
$ sudo -iu ubuntu php ~ubuntu/current/admin/tool/phpunit/cli/util.php --buildconfig
$ vendor/bin/phpunit --verbose
```

And the equivalent for Behat:

```
$ sudo -iu ubuntu php ~ubuntu/current/admin/tool/behat/cli/init.php
$ vendor/bin/behat --config ~ubuntu/data/behat/behat/behat.yml --profile chrome --verbose
```

## Key differences

The Docker configuration differs from other configurations in a number of ways due to design constraints of tools it's designed to operate within.

### All roles bundled together

Docker images contain the following role loadout:

* `app`
* `app-debug`
* `db-pgsql`
* `selenium-hub`
* `selenium-node-chrome`.

As more CI services adopt [Docker Compose](https://docs.docker.com/compose/) or similar to support multiple containers, we will revisit this decision.

### Filesystem ACLs

Ubiquitous ordinarily requires that application server `/home` filesystems support extended attributes and, in turn, ACLs. Since none of Docker's many filesystems support ACLs, we instead run all services under the user account that owns the platform files.

### iptables

Since containers do not maintain their own kernels, there is no notion of an iptables-based firewall within them. iptables rules are not applied to Docker containers; we instead use [`EXPOSE` directives in the Dockerfile](https://docs.docker.com/engine/reference/builder/#expose).

### systemd

Docker is designed to contain individual processes within each container. In lieu of an init system running in each container, you're encouraged to manage multiple containers using [Docker Compose](https://docs.docker.com/compose/). Unfortunately this is not how CI platforms such as [GitLab CI](https://about.gitlab.com/gitlab-ci/) and [Bitbucket Pipelines](https://bitbucket.org/product/features/pipelines) are using containers.

It's impractical to enable and use it within containers, requiring either very specific volume configurations or executing the container in `--privileged` mode. Since both options are unreasonable from a security standpoint, we have worked around this by providing our own launch script to manage the services.

## Recommended CI configurations

These configurations should form a good base for your own environment.

### BitBucket Pipelines

```yaml
image: lukecarrier/moodle-ubiquitous

pipelines:
  default:
    - step:
        script:
          - /usr/local/ubiquitous/bin/ubiquitous-ctl start
          - cp -r * ~ubuntu/releases/test
          - cp ~ubuntu/config.php ~ubuntu/releases/test/config.php
          - chown -R ubuntu:ubuntu ~ubuntu/releases/test
          - sudo -iu ubuntu php ~ubuntu/current/admin/cli/install_database.php --agree-license --adminpass='P4$$word'
          - sudo -iu ubuntu php ~ubuntu/current/admin/tool/phpunit/cli/init.php
          - sudo -iu ubuntu ~ubuntu/current/vendor/bin/phpunit --verbose
          - sudo -iu ubuntu php ~ubuntu/current/admin/tool/behat/cli/init.php --parallel=4
          - sudo -iu ubuntu php ~ubuntu/current/admin/tool/behat/cli/run.php --verbose --profile=chrome
```

## Troubleshooting

Note that more in-depth documentation around the Selenium configuration can be found on [the Selenium role page](../roles/selenium.md). The documentationm below is specific to the Docker container.

### Watching tests over VNC

A VNC server is shipped with the container but is not started by default. To launch it:

```
$ /usr/local/ubiquitous/bin/ubiquitous-ctl start x11vnc
```

### Remoting in with SSH

As the base role is implicitly applied to the container, an OpenSSH server is installed and available for use. If you're unable to effectively troubleshoot over a single session, it can be started as follows:

```
$ mkdir /var/run/sshd
$ sshd
```
