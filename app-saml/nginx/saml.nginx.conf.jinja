{% set ssl = 'ssl' in platform['nginx'] and platform['nginx']['ssl'] %}

server {
    listen 80;
    server_name {{ domain }}{% if 'aliases' in platform %} {{ platform['aliases'] | join(' ') }}{% endif %};

    root {{ platform['user']['home'] }}/releases/simplesamlphp/www;
    index index.php index.html;

    # Security features
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Backend-Server $hostname;

    access_log /var/log/nginx/{{ platform['basename'] }}/access.log{% if 'access_log_format' in platform['nginx'] %} {{ platform['nginx']['access_log_format'] }}{% endif %};
    error_log /var/log/nginx/{{ platform['basename'] }}/error.log error;

    client_max_body_size {{ platform['nginx']['client_max_body_size'] }};

    include "sites-extra/{{ platform['basename'] }}.*.conf";

    location ~ ^/(status|ping)$ {
{% for client in salt['pillar.get']('php-fpm:status_clients', []) %}
        allow {{ client }};
{% endfor %}
        deny all;

        include fastcgi.conf;
        fastcgi_pass unix:/var/run/php/php7.0-fpm-{{ platform['basename'] }}.sock;
    }

    location / {
{% if ssl and salt['file.file_exists']('/etc/letsencrypt/live/' + domain + '/fullchain.pem') %}
        return 301 https://$host$request_uri;
{% else %}
        location ~ \.php(/|$) {
            # Default Debian configuration is too greedy -- doesn't handle URLs
            # with multiple instances of ".php", e.g.:
            #
            # /module.php/core/frontpage_welcome.php
            fastcgi_split_path_info ^(.+?\.php)(/.*)$;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO       $fastcgi_path_info;

            # Everything below here has been added from the snippets/fastcgi-php file.
            # The ordering is somehow compiled wrong and explicit setting this again here
            # in the explicit order fixes that.
            try_files $fastcgi_script_name =404;

            # Workaround try_files resetting $fastcgi_path_info
            set $path_info $fastcgi_path_info;
            fastcgi_param PATH_INFO $path_info;

            fastcgi_index index.php;
            include fastcgi.conf;

            fastcgi_pass unix:/var/run/php/php7.0-fpm-{{ platform['basename'] }}.sock;
        }
{% endif %}
    }
}

{% if ssl and salt['file.file_exists']('/etc/letsencrypt/live/' + domain + '/fullchain.pem') %}
server {
    listen 443 ssl;
    server_name {{ domain }}{% if 'aliases' in platform %} {{ platform['aliases'] | join(' ') }}{% endif %};

    root {{ platform['user']['home'] }}/releases/simplesamlphp/www;
    index index.php index.html;

    # Security features
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Backend-Server $hostname;

    ssl on;
    ssl_certificate {{ platform['nginx']['ssl_certificate'] }};
    ssl_certificate_key {{ platform['nginx']['ssl_certificate_key'] }};

    access_log /var/log/nginx/{{ platform['basename'] }}/access.log{% if 'access_log_format' in platform['nginx'] %} {{ platform['nginx']['access_log_format'] }}{% endif %};
    error_log /var/log/nginx/{{ platform['basename'] }}/error.log error;

    client_max_body_size {{ platform['nginx']['client_max_body_size'] }};

    include "sites-extra/{{ platform['basename'] }}.*.conf";

    location ~ ^/(status|ping)$ {
{% for client in salt['pillar.get']('php-fpm:status_clients', []) %}
        allow {{ client }};
{% endfor %}
        deny all;

        include fastcgi.conf;
        fastcgi_pass unix:/var/run/php/php7.0-fpm-{{ platform['basename'] }}.sock;
    }


    location ~ \.php(/|$) {
        # Default Debian configuration is too greedy -- doesn't handle URLs
        # with multiple instances of ".php", e.g.:
        #
        # /module.php/core/frontpage_welcome.php
        fastcgi_split_path_info ^(.+?\.php)(/.*)$;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO       $fastcgi_path_info;

        # Everything below here has been added from the snippets/fastcgi-php file.
        # The ordering is somehow compiled wrong and explicit setting this again here
        # in the explicit order fixes that.
        try_files $fastcgi_script_name =404;

        # Workaround try_files resetting $fastcgi_path_info
        set $path_info $fastcgi_path_info;
        fastcgi_param PATH_INFO $path_info;

        fastcgi_index index.php;
        include fastcgi.conf;

        fastcgi_pass unix:/var/run/php/php7.0-fpm-{{ platform['basename'] }}.sock;
    }
}
{% endif %}
